<!DOCTYPE html>
<html lang="en">
  <head>
    <base href="/MySqlConnector/" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Documentation for MySqlConnector: an Async MySQL Driver for .NET and .NET Core">
    <meta name="author" content="MySqlConnector Authors">
    
    <link rel="apple-touch-icon" sizes="57x57" href="img/icons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="img/icons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="img/icons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="img/icons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="img/icons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="img/icons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="img/icons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="img/icons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="img/icons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="img/icons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="img/icons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/icons/favicon-16x16.png">
    <link rel="manifest" href="img/icons/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    

    <meta name="generator" content="Hugo 0.32" />
    
    <title>MySqlConnector - Use with .NET Core MVC</title>

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <link rel="stylesheet" type="text/css" href="assets/prism/css/prism.css" />
  </head>

  <body>

    <div class="container">
        <div class="masthead">
            <ul class="nav nav-pills pull-right">
            <li><a href="https://github.com/mysql-net/MySqlConnector/">GitHub</a></li>
            </ul>
            <h3 class="muted"><a href="index.html">MySqlConnector</a></h3>
        </div>
        <hr />
        <div class="row">
            <div class="span9" id="main">




<h1 id="use-with-net-core-mvc-2-0">Use with .NET Core MVC 2.0</h1>

<p>This tutorial will walk through a basic .NET Core JSON API application that performs CRUD operations on
blog posts.  The code in this tutorial comes is an adaptation of <a href="https://github.com/mysql-net/MySqlConnector/tree/master/tests/MySqlConnector.Performance">MySqlConnector.Performance</a>,
the performance application that is used to stress test MySqlConnector.</p>

<h3 id="initialize-mysql">Initialize MySQL</h3>

<p>Create a MySQL database and copy the following SQL to create a table called <code>BlogPost</code>:</p>

<pre><code class="language-txt">CREATE TABLE IF NOT EXISTS `BlogPost` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Content` longtext,
  `Title` longtext,
  PRIMARY KEY (`Id`)
) ENGINE=InnoDB;
</code></pre>

<h3 id="initialize-net-core-mvc">Initialize .NET Core MVC</h3>

<p>Run <code>dotnet new webapi</code> at the root to create the initial project, then run <code>dotnet add package MySqlConnector</code>. You should have a working project at this point, use <code>dotnet run</code> to verify the project builds and runs successfully.</p>

<h3 id="update-configuration-files">Update Configuration Files</h3>

<p><code>appsettings.json</code> holds .NET Core logging levels and the ADO.NET Connection String:</p>

<pre><code class="language-json">{
    &quot;Logging&quot;: {
        &quot;IncludeScopes&quot;: false,
        &quot;LogLevel&quot;: {
            &quot;Default&quot;: &quot;Error&quot;,
            &quot;System&quot;: &quot;Error&quot;,
            &quot;Microsoft&quot;: &quot;Error&quot;
        }
    },
    &quot;ConnectionStrings&quot;: {
        &quot;DefaultConnection&quot;: &quot;server=127.0.0.1;user id=mysqltest;password=test;port=3306;database=blog;&quot;,
    }
}
</code></pre>

<p><code>AppDb.cs</code> is a disposable <a href="overview/configuration/">Application Database Object</a>, adapted to read the ConnectionString
from the Configuration Object:</p>

<pre><code class="language-csharp">using System;
using MySql.Data.MySqlClient;

namespace MySqlConnector.Performance
{
    public class AppDb : IDisposable
    {
        public MySqlConnection Connection;

        public AppDb(string connectionString)
        {
            Connection = new MySqlConnection(connectionString);
        }

        public void Dispose()
        {
            Connection.Close();
        }
    }
}
</code></pre>

<h3 id="net-core-startup">.NET Core Startup</h3>

<p><code>Startup.cs</code> contains runtime configuration and framework services. Add this call to <code>ConfigureServices</code> to make an instance of <code>AppDb</code> available to controller methods.</p>

<pre><code class="language-csharp">services.AddTransient&lt;AppDb&gt;(_ =&gt; new AppDb(Configuration[&quot;ConnectionStrings:DefaultConnection&quot;]));
</code></pre>

<p>Now our app is configured and we can focus on writing the core functionality!</p>

<h3 id="models">Models</h3>

<p><code>BlogPost.cs</code> represents a single Blog Post, and contains Insert, Update, and Delete methods.</p>

<pre><code class="language-csharp">using System.Data;
using System.Threading.Tasks;
using MySql.Data.MySqlClient;
using Newtonsoft.Json;

namespace MySqlConnector.Performance.Models
{
    public class BlogPost
    {
        public int Id { get; set; }
        public string Title { get; set; }
        public string Content { get; set; }

        [JsonIgnore]
        public AppDb Db { get; set; }

        public BlogPost(AppDb db=null)
        {
            Db = db;
        }

        public async Task InsertAsync()
        {
            var cmd = Db.Connection.CreateCommand() as MySqlCommand;
            cmd.CommandText = @&quot;INSERT INTO `BlogPost` (`Title`, `Content`) VALUES (@title, @content);&quot;;
            BindParams(cmd);
            await cmd.ExecuteNonQueryAsync();
            Id = (int) cmd.LastInsertedId;
        }

        public async Task UpdateAsync()
        {
            var cmd = Db.Connection.CreateCommand() as MySqlCommand;
            cmd.CommandText = @&quot;UPDATE `BlogPost` SET `Title` = @title, `Content` = @content WHERE `Id` = @id;&quot;;
            BindParams(cmd);
            BindId(cmd);
            await cmd.ExecuteNonQueryAsync();
        }

        public async Task DeleteAsync()
        {
            var cmd = Db.Connection.CreateCommand() as MySqlCommand;
            cmd.CommandText = @&quot;DELETE FROM `BlogPost` WHERE `Id` = @id;&quot;;
            BindId(cmd);
            await cmd.ExecuteNonQueryAsync();
        }

        private void BindId(MySqlCommand cmd)
        {
            cmd.Parameters.Add(new MySqlParameter
            {
                ParameterName = &quot;@id&quot;,
                DbType = DbType.Int32,
                Value = Id,
            });
        }

        private void BindParams(MySqlCommand cmd)
        {
            cmd.Parameters.Add(new MySqlParameter
            {
                ParameterName = &quot;@title&quot;,
                DbType = DbType.String,
                Value = Title,
            });
            cmd.Parameters.Add(new MySqlParameter
            {
                ParameterName = &quot;@content&quot;,
                DbType = DbType.String,
                Value = Content,
            });
        }

    }
}
</code></pre>

<p><code>BlogPostQuery.cs</code> contains commands to query Blog Posts from the database:</p>

<pre><code class="language-csharp">using System.Collections.Generic;
using System.Data;
using System.Data.Common;
using System.Threading.Tasks;
using MySql.Data.MySqlClient;

namespace MySqlConnector.Performance.Models
{
    public class BlogPostQuery
    {

        public readonly AppDb Db;
        public BlogPostQuery(AppDb db)
        {
            Db = db;
        }

        public async Task&lt;BlogPost&gt; FindOneAsync(int id)
        {
            var cmd = Db.Connection.CreateCommand() as MySqlCommand;
            cmd.CommandText = @&quot;SELECT `Id`, `Title`, `Content` FROM `BlogPost` WHERE `Id` = @id&quot;;
            cmd.Parameters.Add(new MySqlParameter
            {
                ParameterName = &quot;@id&quot;,
                DbType = DbType.Int32,
                Value = id,
            });
            var result = await ReadAllAsync(await cmd.ExecuteReaderAsync());
            return result.Count &gt; 0 ? result[0] : null;
        }

        public async Task&lt;List&lt;BlogPost&gt;&gt; LatestPostsAsync()
        {
            var cmd = Db.Connection.CreateCommand();
            cmd.CommandText = @&quot;SELECT `Id`, `Title`, `Content` FROM `BlogPost` ORDER BY `Id` DESC LIMIT 10;&quot;;
            return await ReadAllAsync(await cmd.ExecuteReaderAsync());
        }

        public async Task DeleteAllAsync()
        {
            var txn = await Db.Connection.BeginTransactionAsync();
            try
            {
                var cmd = Db.Connection.CreateCommand();
                cmd.CommandText = @&quot;DELETE FROM `BlogPost`&quot;;
                await cmd.ExecuteNonQueryAsync();
                await txn.CommitAsync();
            }
            catch
            {
                await txn.RollbackAsync();
                throw;
            }
        }

        private async Task&lt;List&lt;BlogPost&gt;&gt; ReadAllAsync(DbDataReader reader)
        {
            var posts = new List&lt;BlogPost&gt;();
            using (reader)
            {
                while (await reader.ReadAsync())
                {
                    var post = new BlogPost(Db)
                    {
                        Id = await reader.GetFieldValueAsync&lt;int&gt;(0),
                        Title = await reader.GetFieldValueAsync&lt;string&gt;(1),
                        Content = await reader.GetFieldValueAsync&lt;string&gt;(2)
                    };
                    posts.Add(post);
                }
            }
            return posts;
        }
    }
}
</code></pre>

<h3 id="controller">Controller</h3>

<p><code>AsyncController.cs</code> expose Async API Endpoints for CRUD operations on Blog Posts:</p>

<pre><code class="language-csharp">using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using MySqlConnector.Performance.Models;

namespace MySqlConnector.Performance.Controllers
{
    [Route(&quot;api/[controller]&quot;)]
    public class AsyncController : Controller
    {
        // GET api/async
        [HttpGet]
        public async Task&lt;IActionResult&gt; GetLatest()
        {
            using (var db = new AppDb())
            {
                await db.Connection.OpenAsync();
                var query = new BlogPostQuery(db);
                var result = await query.LatestPostsAsync();
                return new OkObjectResult(result);
            }
        }

        // GET api/async/5
        [HttpGet(&quot;{id}&quot;)]
        public async Task&lt;IActionResult&gt; GetOne(int id)
        {
            using (var db = new AppDb())
            {
                await db.Connection.OpenAsync();
                var query = new BlogPostQuery(db);
                var result = await query.FindOneAsync(id);
                if (result == null)
                return new NotFoundResult();
                return new OkObjectResult(result);
            }
        }

        // POST api/async
        [HttpPost]
        public async Task&lt;IActionResult&gt; Post([FromBody]BlogPost body)
        {
            using (var db = new AppDb())
            {
                await db.Connection.OpenAsync();
                body.Db = db;
                await body.InsertAsync();
                return new OkObjectResult(body);
            }
        }

        // PUT api/async/5
        [HttpPut(&quot;{id}&quot;)]
        public async Task&lt;IActionResult&gt; PutOne(int id, [FromBody]BlogPost body)
        {
            using (var db = new AppDb())
            {
                await db.Connection.OpenAsync();
                var query = new BlogPostQuery(db);
                var result = await query.FindOneAsync(id);
                if (result == null)
                    return new NotFoundResult();
                result.Title = body.Title;
                result.Content = body.Content;
                await result.UpdateAsync();
                return new OkObjectResult(result);
            }
        }

        // DELETE api/async/5
        [HttpDelete(&quot;{id}&quot;)]
        public async Task&lt;IActionResult&gt; DeleteOne(int id)
        {
            using (var db = new AppDb())
            {
                await db.Connection.OpenAsync();
                var query = new BlogPostQuery(db);
                var result = await query.FindOneAsync(id);
                if (result == null)
                    return new NotFoundResult();
                await result.DeleteAsync();
                return new OkResult();
            }
        }

        // DELETE api/async
        [HttpDelete]
        public async Task&lt;IActionResult&gt; DeleteAll()
        {
            using (var db = new AppDb())
            {
                await db.Connection.OpenAsync();
                var query = new BlogPostQuery(db);
                await query.DeleteAllAsync();
                return new OkResult();
            }
        }
    }
}
</code></pre>

<h3 id="run-the-app">Run the App</h3>

<p>Congratulations, you should have a fully functional app at this point!  You should be able to run <code>dotnet run</code> to start your application.</p>

<p>The following API Endpoints should work.  Note to set <code>Content-Type: application/json</code> headers on <code>POST</code> and <code>PUT</code> methods.</p>

<pre><code class="language-txt">POST http://localhost:5000/api/async
{ &quot;Title&quot;: &quot;One&quot;, &quot;Content&quot;: &quot;First Blog Post!&quot; }

POST http://localhost:5000/api/async
{ &quot;Title&quot;: &quot;Two&quot;, &quot;Content&quot;: &quot;Second Blog Post!&quot; }

POST http://localhost:5000/api/async
{ &quot;Title&quot;: &quot;Three&quot;, &quot;Content&quot;: &quot;Third Blog Post!&quot; }

GET http://localhost:5000/api/async
// Output:
[
    { &quot;Id&quot;: 3, &quot;Title&quot;: &quot;Three&quot;, &quot;Content&quot;: &quot;Third Blog Post!&quot; },
    { &quot;Id&quot;: 2, &quot;Title&quot;: &quot;Two&quot;, &quot;Content&quot;: &quot;Second Blog Post!&quot; },
    { &quot;Id&quot;: 1, &quot;Title&quot;: &quot;One&quot;, &quot;Content&quot;: &quot;First Blog Post!&quot;}
]

DELETE http://localhost:5000/api/async/1
// blog post 1 is gone

PUT http://localhost:5000/api/async/2
{ &quot;Title&quot;: &quot;Two&quot;, &quot;Content&quot;: &quot;Second Blog Post Revised&quot; }

GET http://localhost:5000/api/async
// Output:
[
    { &quot;Id&quot;: 3, &quot;Title&quot;: &quot;Three&quot;, &quot;Content&quot;: &quot;Third Blog Post!&quot; },
    { &quot;Id&quot;: 2, &quot;Title&quot;: &quot;Two&quot;, &quot;Content&quot;: &quot;Second Blog Post Revised&quot; },
]

DELETE http://localhost:5000/api/async
// all blog posts are gone

GET http://localhost:5000/api/async
// Output:
[]
</code></pre>

<p>If you would like to see all of this code and more on GitHub, check out <a href="https://github.com/mysql-net/MySqlConnector/tree/master/tests/MySqlConnector.Performance">MySqlConnector.Performance</a>.</p>


        </div>
        <div class="span3">
    <ul class="nav nav-list" id="menu">

        
        <li class="nav-header">
            <a href="">Home</a>
        </li>

        

        
        <li class="nav-header">
            Getting Started
        </li>

        
        <li>
            <a href="/MySqlConnector/overview/installing/">Installing</a>
        </li>
        
        <li>
            <a href="/MySqlConnector/overview/known-issues/">Known Issues</a>
        </li>
        
        <li>
            <a href="/MySqlConnector/overview/version-history/">Version History</a>
        </li>
        
        <li>
            <a href="/MySqlConnector/overview/configuration/">Configuration</a>
        </li>
        
        <li>
            <a href="/MySqlConnector/overview/logging/">Logging</a>
        </li>
        
        <li>
            <a href="/MySqlConnector/overview/use-with-orms/">Use with ORMs</a>
        </li>
        

        
        <li class="nav-header">
            <a href="/MySqlConnector/connection-options/">Connection Options</a>
        </li>

        

        
        <li class="nav-header">
            Tutorials
        </li>

        
        <li>
            <a href="/MySqlConnector/tutorials/basic-api/">Basic API</a>
        </li>
        
        <li>
            <a href="/MySqlConnector/tutorials/best-practices/">Best Practices</a>
        </li>
        
        <li>
            <a href="/MySqlConnector/tutorials/migrating-from-connector-net/">Migrating from Connector/NET</a>
        </li>
        
        <li>
            <a href="/MySqlConnector/tutorials/net-core-mvc/">Use with .NET Core MVC</a>
        </li>
        

        
        <li class="nav-header">
            API
        </li>

        
        <li>
            <a href="/MySqlConnector/api/mysql-connection/">MySqlConnection</a>
        </li>
        
        <li>
            <a href="/MySqlConnector/api/mysql-command/">MySqlCommand</a>
        </li>
        
        <li>
            <a href="/MySqlConnector/api/mysql-data-reader/">MySqlDataReader</a>
        </li>
        
        <li>
            <a href="/MySqlConnector/api/mysql-transaction/">MySqlTransaction</a>
        </li>
        

        
        <li class="nav-header">
            Troubleshooting
        </li>

        
        <li>
            <a href="/MySqlConnector/troubleshooting/connection-reuse/">Connection Reuse</a>
        </li>
        
        <li>
            <a href="/MySqlConnector/troubleshooting/transaction-usage/">Transaction Usage</a>
        </li>
        

        
    </ul>
</div>

      </div>
    </div>

    
    <script type="text/javascript" src="assets/prism/js/prism.js"></script>
  </body>
</html>

